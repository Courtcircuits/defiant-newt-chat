
import os
import socket
import configparser
import base64
import datetime

from cryptography.hazmat.primitives.ciphers import (
    Cipher,
    algorithms,
    modes
)



def decrypt_message(key_AES, received_concatenation):
    """Decrypts a message encrypted with AES-GCM.

    Args:
        key_AES (bytes): The AES key used for decryption.
        received_concatenation (str): The base64-encoded concatenated tag, nonce, and ciphertext.

    Returns:
        str: The decrypted plaintext message.

    Raises:
        InvalidTag: If the decryption fails due to an invalid tag.
    """

    received_message = base64.b64decode(received_concatenation.encode('utf-8'))
    tag = received_message[:16] # tag is 16 bytes long
    nonce = received_message[16:28] # nonce is 12 bytes long
    ciphertext = received_message[28:] # length of ciphertext unknown

    decryptor = Cipher(
        algorithms.AES(key_AES),
        modes.GCM(nonce, tag),
    ).decryptor()

    plaintext = decryptor.update(ciphertext) + decryptor.finalize()

    return plaintext.decode('utf-8')

def main():
    key = input("Please enter the key: ")
    message = input("Please enter the message: ")
    key_AES = bytes.fromhex(key)
    decrypted_message = decrypt_message(key_AES, message)
    print(decrypted_message)

    
if __name__ == "__main__":
    main()
